<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <title>Tesla Auth token fetcher</title>
</head>

<style>
  body {
    font: 200 1em sans-serif;
    color: #1b1919;
    background-color: #fdfdfd;
    max-width: 800px;
    margin: 0 auto;
    padding: 0 1em;
  }

  a {
    font-weight: bold;
    text-decoration: none;
    color: #2d2daf;
  }

  body,
  input {
    text-align: center;
  }

  p,
  li {
    text-align: left;
    margin-bottom: 0.2em;
  }

  form,
  button,
  .token {
    margin-bottom: 1em;
  }

  ul {
    list-style-type: circle;
    list-style-position: inside;
    padding: 0;
  }

  button {
    background: #4747ad;
    border: none;
    color: white;
    padding: 0.4em;
    width: 150px;
    font-size: 17px;
  }

  button:hover {
    background: #7676de;
  }

  button:active {
    background: #212161;
  }

  input {
    display: block;
    width: 400px;
    font-size: 1em;
    padding: 0.2em;
    margin: 0.2em auto 1em;
  }

  .token {
    position: relative;
  }

  .token span {
    font-size: 0.9em;
  }

  .token input {
    width: 90%;
    font: 600 1.2em monospace;
    padding: 0.6em;
  }

  .token textarea {
    display: block;
    width: 90%;
    height: 12em;
    margin: 0.2em auto 1em;
    font: 600 0.9em monospace;
    white-space: normal;
    word-break: break-all;
  }

  .copybtn {
    margin: 0 4% 0 0;
    padding: 0.2em 1em;
    width: auto;
    position: absolute;
    right: 0;
    top: 0;
    font-size: 0.9em;
  }

  #error>div {
    display: block;
    margin: 2em;
    border: 2px solid #e4d4cd;
    background-color: #f5ede7;
    padding: 1em;
    color: #a93600;
  }

  #captchaImg {
    display: block;
    margin: 0 auto;
  }
</style>

<body>
  <h1><a href="/">Tesla token fetcher</a></h1>
  <p>This is a simple node.js server for authenticating with the Tesla servers to obtain both
    authentication access and refresh tokens, as well as owner-api access tokens.</p>
  <p><strong>Why a server?</strong>
    The Tesla API was not intended for direct use in browsers and <a
      href="https://developer.mozilla.org/en-US/docs/Web/HTTP/CORS">CORS</a> is preventing it. The server acts as a
    simple proxy to bypass this without storing any information.</p>
  <p><strong>Is it safe?</strong>
    Yes. But don't just trust my word, verify!
  <ul>
    <li>It's open source (<a href="https://github.com/fredli74/fetch-tesla-token">GitHub</a>)</li>
    <li><a href="https://github.com/fredli74/fetch-tesla-token#how-do-i-run-it-locally">Download and run locally</a>
    </li>
    <li>Server only using node.js standard library (no node_modules needed)</li>
    <li>Client is single html file (no third-party browser libraries)</li>
    <li>Small code base, review it all in minutes</li>
  </ul>
  </p>

  <div id="dynamic">
    Contacting Tesla server...
  </div>

  <div id="error"></div>
</body>

<script>
  const elError = document.getElementById("error");
  function clearError() {
    elError.innerHTML = "";
  }
  function showError(error) {
    elError.innerHTML = `<div>${error}</div>`;
  }

  const elDynamic = document.getElementById("dynamic");

  let session;
  let formData;

  // Call an RPC function on the server
  async function rpc(url, data) {
    const response = await fetch(url, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ session, ...data }),
    });
    if (!response.ok) {
      throw new Error(response.headers.get("X-Error") || 'Unknown error from server')
    }
    return await response.json();
  }

  async function newSession() {
    try {
      const data = await rpc("/session");
      session = data.session;
      formData = data.htmlForm;

      if (!session || !formData || !formData.transaction_id) {
        throw new Error("Unable to detect all fields from sign in form");
      }

      // Create the sign in form
      const html = [`
        <form id="form" action="" method="POST">
          <label for="email">Tesla Account Email</label>
          <input type="email" id="email" autocomplete="email" autocorrect="off" autocapitalize="none" placeholder="email" required>
          <label for="password">Password</label>
          <input type="password" id="password" autocomplete="off" autocorrect="off" autocapitalize="none" placeholder="password" required>
      `];

      if (formData.captcha !== undefined) {
        html.push(`
          <img id="captchaImg" alt="">
          <label for="captcha">Enter the characters in the picture</label>
          <input type="text" id="captcha" autocomplete="off" autocorrect="off" autocapitalize="none" required>
        `);
      }

      html.push(`
          <button type="submit" id="authenticate">authenticate</button>
        </form>
      `);
      elDynamic.innerHTML = html.join("");

      /* Hook up event listeners to the form */
      const elForm = document.getElementById("form");
      const elEmail = document.getElementById("email");
      const elPassword = document.getElementById("password");
      const elCaptchaImg = document.getElementById("captchaImg");
      const elCaptcha = document.getElementById("captcha");

      async function resetForm() {
        if (elCaptchaImg) {
          elCaptchaImg.src = (await rpc("/captcha", { session })).image;
          elCaptcha.value = "";
        }
        elPassword.value = "";
        if (elEmail.value == "") {
          elEmail.focus();
        } else {
          elPassword.focus();
        }
      }
      resetForm();

      elEmail.addEventListener("keypress", (event) => {
        if (event.keyCode === 13) {
          if (elPassword) {
            event.preventDefault();
            elPassword.focus();
          }
        }
      });
      elPassword.addEventListener("keypress", (event) => {
        if (event.keyCode === 13) {
          if (elCaptcha) {
            event.preventDefault();
            elCaptcha.focus();
          }
        }
      });
      elForm.addEventListener("submit", async (event) => {
        event.preventDefault();
        clearError();

        formData.identity = elEmail.value;
        formData.credential = elPassword.value;
        formData.captcha = elCaptcha.value;

        try {
          const data = await rpc("/authenticate", { form: formData });
          if (data.response === "mfa") {
            createFactorForm(data.mfaFactors);
          } else {
            showToken(data);
          }
        } catch (e) {
          // Handle errors in the form submit
          showError(e);
          resetForm();
        }
      });

    } catch (e) {
      // Handle errors in newSession call
      showError(e);
    }

  }

  async function createFactorForm(factors) {
    // TODO: show options and let user choose the MFA factor
    elDynamic.innerHTML = `
      <form id="factorForm" action="" method="POST">
        <label for="mfa">MFA Passcode</label>
        <input type="text" id="mfa" autocomplete="off" autocorrect="off" autocapitalize="none" placeholder="code" required>
        <button type="submit" id="authenticate">authenticate</button>
      </form>`;

    /* Hook up event listeners to the form */
    const elForm = document.getElementById("factorForm");
    const elMFA = document.getElementById("mfa");

    async function resetFactorForm() {
      elMFA.value = "";
      elMFA.focus();
    }

    elForm.addEventListener("submit", async (event) => {
      event.preventDefault();
      clearError();

      const passcode = elMFA.value;
      const transaction_id = formData.transaction_id;

      let error;
      for (let mfa of factors) {
        if (mfa.factorType === "token:software") {
          const factor_id = mfa.id;
          try {
            await rpc("/validate", { transaction_id, passcode, factor_id });
            const data = await rpc("/authenticate", { form: { transaction_id } });
            showToken(data);
            return
          } catch (e) {
            // Ignore errors but save the message
            error = e && e.message;
          }
        }
      }
      if (error) {
        showError(error);
      }
      resetFactorForm();
    });

    resetFactorForm();
  }

  function showToken(data) {
    const html = [];
    if (location.hash !== "#refresh_token") {
      html.push(`
        <div id="accesstoken" class="token">
          <span>Access Token <button class="copybtn" onclick="copy('accessArea')">copy</button></span>
          <textarea id="accessArea" readonly>${data.auth.access_token}</textarea>
        </div>
        <div id="apitoken" class="token">
          <span>Owner-API Token <button class="copybtn" onclick="copy('apiInput')">copy</button></span>
          <input id="apiInput" readonly value="${data.owner_api.access_token}">
        </div>
      `);
    }
    html.push(`
      <div id="refreshtoken" class="token">
        <span>Refresh Token <button class="copybtn" onclick="copy('refreshArea')">copy</button></span>
        <textarea id="refreshArea" readonly>${data.auth.refresh_token}</textarea>
      </div>
    `);
    elDynamic.innerHTML = html.join("");
  }

  function copy(id) {
    const el = document.getElementById(id);
    el.select();
    el.setSelectionRange(0, 99999)
    document.execCommand("copy");
  }

  newSession();
</script>

<noscript style="color:red">Your browser does not support JavaScript!</noscript>

</html>